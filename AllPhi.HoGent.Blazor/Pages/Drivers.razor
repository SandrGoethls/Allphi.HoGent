@page "/drivers"

@using AllPhi.HoGent.Blazor.Services
@using AllPhi.HoGent.Blazor.Dto
@using AllPhi.HoGent.Blazor.Dto.Enums
@using AllPhi.HoGent.Blazor.Components

@inject IDriverServices _driverService
@inject IVehicleServices _vehicleService
@inject IFuelCardServices _fuelCardService
@inject IFuelCardDriverServices _fuelCardDriverService
@inject IDriverVehicleServices _driverVehicleService


<PageTitle>Drivers</PageTitle>

@if (_isLoading)
{
    <LoadingSpinner IsLoading="@_isLoading" />
}



@code {

    private bool _isLoading = true;

    private FuelCardListDto? _fuelCardListDto;
    private VehicleListDto? _vehicleListDto;
    private DriverListDto? _driverListDto;

    private DriverDto _selectedDriverDto = new();
    private List<FuelCardDriverDto> _fuelCardDriverDtos = new();
    private List<FuelCardDto> _checkedfuelCard = new();
    private List<VehicleDto> _checkedVehicle = new();
    private List<DriverVehicleDto> _driverVehicleDtos = new();


    private bool _isSortAscending = true;
    private string _currentSortColumn = "date";
    private int _pageSize = 5;
    private int _pageNumber = 1;
    private int _totalPages;

    public string ErrorTitle { get; set; } = string.Empty;
    public string ErrorMessage { get; set; } = string.Empty;

    private bool _driverAdded = false;
    private bool _driverUpdated = false;
    private bool _driverDeleted = false;

    private bool _selectedDriver = false;
    private bool _addNewFuelCard = false;
    private bool _showSendConfirmation = false;
    private bool _error = false;

    protected override async Task OnInitializedAsync()
    {
        _fuelCardListDto = await _fuelCardService.GetAllFuelCardsAsync();
        _vehicleListDto = await _vehicleService.GetAllVehicleAsync();

        await LoadDriverListDto();
        _isLoading = false;
    }

    private async Task LoadDriverListDto()
    {
        _driverListDto = await _driverService.GetAllDriversAsync(_currentSortColumn, _isSortAscending, _pageNumber, _pageSize);
        _totalPages = (int)Math.Ceiling((double)_vehicleListDto.TotalItems / _pageSize);
    }

    private void AddNewDriver()
    {
        SetBoolDefault();

        _selectedDriver = false;
        _addNewFuelCard = true;
    }

    private void SetBoolDefault()
    {
        _showSendConfirmation = false;
        _error = false;
    }


    private async Task SelectDriver(DriverDto selectedDriver)
    {
        _selectedDriverDto = selectedDriver;

        _fuelCardDriverDtos = (await _fuelCardDriverService.GetDriverWithConnectedFuelCardsByDriverId(_selectedDriverDto.Id)).Item1;
        var v = _fuelCardDriverDtos.Select(x => _fuelCardListDto.FuelCards.Where(r => x.FuelCardId == r.Id).ToList()).ToList();
        _checkedfuelCard = v.SelectMany(x => x.Select(x => x).ToList()).ToList();

        _driverVehicleDtos = (await _driverVehicleService.GetDriverWithConnectedVehiclesByDriverId(_selectedDriverDto.Id)).Item1;
        var a = _driverVehicleDtos.Select(x => _vehicleListDto.VehicleDtos.Where(r => x.VehicleId == r.Id).ToList()).ToList();
        _checkedVehicle = a.SelectMany(x => x.Select(x => x).ToList()).ToList();

        _showSendConfirmation = false;
        _selectedDriver = true;
        _addNewFuelCard = false;
        _driverAdded = false;
        _driverUpdated = false;
        _driverDeleted = false;
    }

    private async Task SaveNewUser(DriverDto driverDto)
    {
        try
        {
            if (driverDto is not null)
            {
                var (status, statusMessage) = await _driverService.AddFDriverAsync(driverDto);

                var (statusRelatedFuelCards, statusMessageRelatedFuelCards) = await _fuelCardDriverService.UpdateDriverWithFuelCards(driverDto.Id, driverDto.FuelCardDtos.Select(x => x.Id).ToList());

                var (statusRelatedVehicles, statusMessageRelatedVehicles) = await _driverVehicleService.UpdateDriverWithVehicles(driverDto.Id, driverDto.VehicleDtos.Select(x => x.Id).ToList());

                if (!status || !statusRelatedFuelCards || !statusRelatedVehicles)
                {
                    ErrorTitle = " Oei, er ging iets verkeerd tijdens het toevoegen.";
                    ErrorMessage = statusMessage;
                    _error = true;
                }
                else
                    _driverAdded = true;

                _showSendConfirmation = true;
                _driverListDto = await _driverService.GetAllDriversAsync();
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            ErrorTitle = " Oei, er ging iets verkeerd tijdens het toevoegen.";
            ErrorMessage = $"Excuses! Er ging iets verkeerd tijdens het toevoegen. Error: {ex.Message}";
            _error = true;
        }
    }
}