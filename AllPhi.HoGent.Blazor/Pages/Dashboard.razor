@page "/"
@page "/dashboard"

@using AllPhi.HoGent.Blazor.Components
@using AllPhi.HoGent.Blazor.Services
@using AllPhi.HoGent.Blazor.Dto
@using AllPhi.HoGent.Blazor.Dto.Enums

@using ChartJs.Blazor.Common
@using ChartJs.Blazor.Common.Axes
@using ChartJs.Blazor.Common.Axes.Ticks
@using ChartJs.Blazor.Common.Enums
@using ChartJs.Blazor.Common.Handlers
@using ChartJs.Blazor.Common.Time
@using ChartJs.Blazor.PieChart
@using ChartJs.Blazor.Util
@using ChartJs.Blazor.Interop





@inject IDriverServices _driverService
@inject IVehicleServices _vehicleService
@inject IFuelCardServices _fuelCardService
@inject IFuelCardDriverServices _fuelCardDriverService
@inject IDriverVehicleServices _driverVehicleService

<PageTitle>Dashboard</PageTitle>
@if (_isLoading)
{
    <LoadingSpinner IsLoading="@_isLoading" />
}
else
{
    <div class="block block-rounded h-100">
        <div class="block-header">
            <h3 class="block-title">Dashboard Analytics</h3>
        </div>
        <div class="block-content space-y-6">
            <div class="row">
                <div class="col-md-3 card mx-5 p-4 ">
                    <h4>Drivers</h4>
                    <p>Total : @_driverListDto.TotalItems</p>
                    <Chart Config="@_driversChartConfig" Width="50" Height="50" />
                </div>
                <div class="col-md-3 card mx-5 p-4 ">
                    <h4>Vehicles</h4>
                    <p>Total : @_vehicleListDto.TotalItems</p>
                    <Chart Config="@_vehiclesChartConfig" Width="50" Height="50" />
                </div>
                <div class="col-md-3 card mx-5 p-4">
                    <h4>Fuel Cards</h4>
                    <p>Total : @_fuelCardListDto.TotalItems</p>
                    <Chart Config="@_fuelCardsChartConfig" Width="50" Height="50" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 card mx-5 p-4 ">
                    <h4>Upcoming Birthdays</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Driver</th>
                                <th>Birthday</th>

                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var driver in _driverUpcomingBirthday)
                            {
                                <tr>
                                    <td>@driver.FirstName @driver.LastName</td>
                                    <td>@driver.DateOfBirth.ToString("dd-MM-yyyy")</td>

                                </tr>
                            }
                        </tbody>
                    </table>

                </div>


            </div>
        </div>
    </div>
}


@code {

    private FuelCardListDto? _fuelCardListDto;
    private VehicleListDto? _vehicleListDto;
    private DriverListDto? _driverListDto;
    private DriverVehicleListDto? _driverVehicleListDto;


    private bool _isLoading = true;
    private PieConfig _driversChartConfig;
    private PieConfig _vehiclesChartConfig;
    private PieConfig _fuelCardsChartConfig;

    private List<DriverDto> _driverUpcomingBirthday;

    protected override async Task OnInitializedAsync()
    {
        _fuelCardListDto = await _fuelCardService.GetAllFuelCardsAsync();
        _vehicleListDto = await _vehicleService.GetAllVehicleAsync();
        _driverListDto = await _driverService.GetAllDriversAsync();
        _driverVehicleListDto = await _driverVehicleService.GetAllDriverVehicleAsync();

        await Task.Run(() =>
        {
            GetUpcomingBirthdays();
            InitializeCharts();
        });
        _isLoading = false;
    }

    private void GetUpcomingBirthdays()
    {
        if (_driverListDto != null && _driverListDto.DriverDtos != null)
        {
            var today = DateTime.Now;
            var todayPlus10Days = DateTime.Now.AddDays(10);
            _driverUpcomingBirthday = _driverListDto.DriverDtos
                .Where(d =>
                    (new DateTime(today.Year, d.DateOfBirth.Month, d.DateOfBirth.Day) >= today &&
                    new DateTime(today.Year, d.DateOfBirth.Month, d.DateOfBirth.Day) <= todayPlus10Days) ||
                    (d.DateOfBirth.Month == 12 && d.DateOfBirth.Day <= todayPlus10Days.Day - 365)
                ).ToList();
        }
        else
        {
            _driverUpcomingBirthday = new List<DriverDto>();
        }

    }

    private void InitializeCharts()
    {
        // For Drivers
        int driversAssignedToVehicles = _driverVehicleListDto.DriverVehicleDtos.Select(dv => dv.DriverId).Distinct().Count();
        int driversNotAssignedToVehicles = _driverListDto.TotalItems - driversAssignedToVehicles;

        _driversChartConfig = GetChartConfig("Drivers", new int[] { driversNotAssignedToVehicles, driversAssignedToVehicles }, new string[] { "#e74c3c", "#2ecc71" }, 1);

        // For Vehicles
        int vehiclesWithDrivers = _driverVehicleListDto.DriverVehicleDtos.Select(dv => dv.VehicleId).Distinct().Count();
        int vehiclesWithoutDrivers = _vehicleListDto.TotalItems - vehiclesWithDrivers;

        _vehiclesChartConfig = GetChartConfig("Vehicles", new int[] { vehiclesWithoutDrivers, vehiclesWithDrivers }, new string[] { "#f1faee", "#f4a261" }, 2);

        // For Fuel Cards
        int fuelCardsWithDrivers = _fuelCardListDto.FuelCardDtos.Count(fc => fc.DriverDtos != null && fc.DriverDtos.Any());
        int fuelCardsWithoutDrivers = _fuelCardListDto.TotalItems - fuelCardsWithDrivers;

        _fuelCardsChartConfig = GetChartConfig("Fuel Cards", new int[] { fuelCardsWithoutDrivers, fuelCardsWithDrivers }, new string[] { "#457b9d", "#1d3557" }, 3);
    }



    private PieConfig GetChartConfig(string label, int[] data, string[] backgroundColors, int chart)
    {
        var config = new PieConfig(true)
            {


                Options = new PieOptions
                {
                    Responsive = true,
                    Title = new OptionsTitle

                    {
                        Display = true,
                        Text = label + " Distribution"
                    }
                }
            };

        if (chart == 1)
        {
            config.Data.Labels.Clear();
            foreach (var status in new[] { "Available Drivers", "Drivers assigned to vehicle" })
            {
                config.Data.Labels.Add(status);
            }
        }

        if (chart == 2)
        {
            config.Data.Labels.Clear();
            foreach (var status in new[] { "Available Vehicles", "Vehicles assigned to drivers" })
            {
                config.Data.Labels.Add(status);
            }
        }

        if (chart == 3)
        {
            config.Data.Labels.Clear();
            foreach (var status in new[] { "Available Fuelcards", "Fuel assigned to drivers" })
            {
                config.Data.Labels.Add(status);
            }
        }


        var dataset = new PieDataset<int>(data)
            {
                BackgroundColor = backgroundColors,

            };

        config.Data.Datasets.Add(dataset);

        return config;
    }
}

