@page "/"
@page "/dashboard"

@using AllPhi.HoGent.Blazor.Components
@using AllPhi.HoGent.Blazor.Services
@using AllPhi.HoGent.Blazor.Dto
@using AllPhi.HoGent.Blazor.Dto.Enums

@using ChartJs.Blazor.Common
@using ChartJs.Blazor.Common.Axes
@using ChartJs.Blazor.Common.Axes.Ticks
@using ChartJs.Blazor.Common.Enums
@using ChartJs.Blazor.Common.Handlers
@using ChartJs.Blazor.Common.Time
@using ChartJs.Blazor.PieChart
@using ChartJs.Blazor.Util
@using ChartJs.Blazor.Interop


@inject IDriverServices _driverService
@inject IVehicleServices _vehicleService
@inject IFuelCardServices _fuelCardService
@inject IFuelCardDriverServices _fuelCardDriverService
@inject IDriverVehicleServices _driverVehicleService



<style>
    .chart-width {
        width: 30%;
        margin: 5px;
    }

    .chart-description-width {
        width: 30%;
        margin: 5px;
    }

    @@media (max-width: 1550px) {
        .chart-width {
            width: 30%;
            margin: 5px;
        }

        .chart-description-width {
            width: 30%;
            margin: 5px;
        }

        h4 {
            min-height: 50px;
        }

        th {
        }
    }

    @@media (max-width: 1115px) {
        .chart-width {
            width: 30%;
            margin: 5px;
        }

        .chart-description-width {
            width: 30%;
            margin: 5px;
        }

        h4 {
            font-size: 15px !important;
            min-height: 63px;
        }

        th {
            font-size: 9px !important;
        }

        td {
            font-size: 12px !important;
        }
    }

    @@media (max-width: 640px) {
        .chart-width {
            width: 100%;
            margin: 0px;
            margin-top: 5px;
            margin-bottom: 5px;
        }

        .chart-description-width {
            width: 100%;
            margin: 0px;
            margin-top: 5px;
            margin-bottom: 5px;
        }

        h4 {
            font-size: 12px;
        }

        th {
            font-size: 10px !important;
        }
    }
</style>

<PageTitle>Dashboard</PageTitle>
@if (_isLoading)
{
    <LoadingSpinner IsLoading="@_isLoading" />
}
else
{
    <div class="block block-rounded h-100">
        <div class="block-header">
            <h3 class="block-title">Dashboard Analytics</h3>
        </div>
        <div class="block-content space-y-4">
            <div class="row d-flex justify-content-around">
                <div class="chart-width card p-2">
                    <h4>Bestuurders</h4>
                    <p>Total : @_driverListDto.TotalItems</p>
                    <Chart Config="@_driversChartConfig" Width="15" Height="15" />
                </div>
                <div class="chart-width card p-2    ">
                    <h4>Voertuigen</h4>
                    <p>Total : @_vehicleListDto.TotalItems</p>
                    <Chart Config="@_vehiclesChartConfig" Width="15" Height="15" />
                </div>
                <div class="chart-width card p-2  ">
                    <h4>Tankkaarten</h4>
                    <p>Total : @_fuelCardListDto.TotalItems</p>
                    <Chart Config="@_fuelCardsChartConfig" Width="15" Height="15" />
                </div>
            </div>
            <div class="row d-flex justify-content-around">
                <div class="chart-description-width card p-2 table-responsive   ">
                    <h4>Verjaardagen</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Bestuurder</th>
                                <th>Verjaardag</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var driver in _driverUpcomingBirthday)
                            {
                                <tr>
                                    <td>@driver.FirstName @driver.LastName</td>
                                    <td>@driver.DateOfBirth.ToString("dd-MM-yyyy")</td>

                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="chart-description-width card p-2 table-responsive   ">
                    <h4>Voertuigen met naderende Keuringsdatum</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nummerplaat</th>
                                <th>Vervalt op</th>

                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var vehicle in _vehicleUpcomingInspection)
                            {
                                <tr>
                                    <td>@vehicle.LicensePlate </td>
                                    <td>@vehicle.InspectionDate.ToString("dd-MM-yyyy")</td>

                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="chart-description-width card p-2 table-responsive  ">
                    <h4>Tankkaarten met naderende vervaldag</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Kaart Nummer</th>
                                <th>Vervalt op</th>

                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var fuelcard in _fuelCardUpcomingValidity)
                            {
                                <tr>
                                    <td>@fuelcard.CardNumber </td>
                                    <td>@fuelcard.ValidityDate.ToString("dd-MM-yyyy")</td>

                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row d-flex justify-content-around">
                <div class="chart-description-width card p-2 table-responsive  ">
                    <h4>Laatst toegevoegde Bestuurders</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Bestuurder</th>
                                <th>Rijbewijs</th>
                                <th>Toegevoegd op</th>

                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var driver in _lastAddedDrivers)
                            {
                                <tr>
                                    <td>@driver.FirstName @driver.LastName </td>
                                    <td>@driver.TypeOfDriverLicense</td>
                                    <td>@driver.CreatedAt.ToString("dd-MM-yyyy")</td>

                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="chart-description-width card p-2 table-responsive  ">
                    <h4>Laatst toegevoegde Voertuigen</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nummerplaat</th>
                                <th>Fabrikant</th>
                                <th>Toegevoegd op</th>

                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var vehicle in _lastAddedVehicles)
                            {
                                <tr>
                                    <td>@vehicle.LicensePlate </td>
                                    <td>@vehicle.CarBrand</td>
                                    <td>@vehicle.CreatedAt.ToString("dd-MM-yyyy")</td>

                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="chart-description-width card p-2 table-responsive  ">
                    <h4>Laatst toegevoegde Tankkaarten</h4>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>KaartNummer</th>
                                <th>Code</th>
                                <th>Toegevoegd op</th>

                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var fuelcard in _lastAddedFuelCards)
                            {
                                <tr>
                                    <td>@fuelcard.CardNumber </td>
                                    <td>@fuelcard.Pin</td>
                                    <td>@fuelcard.CreatedAt.ToString("dd-MM-yyyy")</td>

                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}


@code {

    private FuelCardListDto? _fuelCardListDto;
    private VehicleListDto? _vehicleListDto;
    private DriverListDto? _driverListDto;
    private DriverVehicleListDto? _driverVehicleListDto;
    private FuelCardDriverListDto? _fuelCardDriverListDto;


    private bool _isLoading = true;
    private PieConfig _driversChartConfig;
    private PieConfig _vehiclesChartConfig;
    private PieConfig _fuelCardsChartConfig;

    private List<DriverDto> _driverUpcomingBirthday;
    private List<FuelCardDto> _fuelCardUpcomingValidity;
    private List<VehicleDto> _vehicleUpcomingInspection;

    private List<DriverDto> _lastAddedDrivers;
    private List<VehicleDto> _lastAddedVehicles;
    private List<FuelCardDto> _lastAddedFuelCards;

    protected override async Task OnInitializedAsync()
    {
        _fuelCardListDto = await _fuelCardService.GetAllFuelCardsAsync();
        _vehicleListDto = await _vehicleService.GetAllVehicleAsync();
        _driverListDto = await _driverService.GetAllDriversAsync();
        _driverVehicleListDto = await _driverVehicleService.GetAllDriverVehicleAsync();
        _fuelCardDriverListDto = await _fuelCardDriverService.GetAllFuelCardDriverAsync();

        await Task.Run(() =>
        {
            GetUpcomingBirthdays();
            GetUpcomingVehicleInspections();
            GetUpcomingValidityFuelCards();
            GetLastAddedDrivers();
            GetLastAddedVehicles();
            GetLastAddedFuelCards();
            InitializeCharts();
        });
        _isLoading = false;
    }

    private void GetUpcomingVehicleInspections()
    {
        if (_vehicleListDto != null && _vehicleListDto.VehicleDtos != null)
        {
            var today = DateTime.Now;
            var todayPlus10Days = DateTime.Now.AddDays(30);
            _vehicleUpcomingInspection = _vehicleListDto.VehicleDtos
                .Where(d =>
                    (new DateTime(today.Year, d.InspectionDate.Month, d.InspectionDate.Day) >= today &&
                    new DateTime(today.Year, d.InspectionDate.Month, d.InspectionDate.Day) <= todayPlus10Days) ||
                    (d.InspectionDate.Month == 12 && d.InspectionDate.Day <= todayPlus10Days.Day - 365)
                ).ToList();
        }
        else
        {
            _vehicleUpcomingInspection = new List<VehicleDto>();
        }

    }

    private void GetUpcomingBirthdays()
    {
        if (_driverListDto != null && _driverListDto.DriverDtos != null)
        {
            var today = DateTime.Now;
            var todayPlus10Days = DateTime.Now.AddDays(10);
            _driverUpcomingBirthday = _driverListDto.DriverDtos
                .Where(d =>
                    (new DateTime(today.Year, d.DateOfBirth.Month, d.DateOfBirth.Day) >= today &&
                    new DateTime(today.Year, d.DateOfBirth.Month, d.DateOfBirth.Day) <= todayPlus10Days) ||
                    (d.DateOfBirth.Month == 12 && d.DateOfBirth.Day <= todayPlus10Days.Day - 365)
                ).ToList();
        }
        else
        {
            _driverUpcomingBirthday = new List<DriverDto>();
        }

    }

    private void GetUpcomingValidityFuelCards()
    {
        if (_fuelCardListDto != null && _fuelCardListDto.FuelCardDtos != null)
        {
            var today = DateTime.Now;
            var todayPlus10Days = DateTime.Now.AddDays(30);
            _fuelCardUpcomingValidity = _fuelCardListDto.FuelCardDtos
                .Where(d =>
                    (new DateTime(today.Year, d.ValidityDate.Month, d.ValidityDate.Day) >= today &&
                    new DateTime(today.Year, d.ValidityDate.Month, d.ValidityDate.Day) <= todayPlus10Days) ||
                    (d.ValidityDate.Month == 12 && d.ValidityDate.Day <= todayPlus10Days.Day - 365)
                ).ToList();
        }
        else
        {
            _fuelCardUpcomingValidity = new List<FuelCardDto>();
        }

    }

    private void GetLastAddedDrivers()
    {
        if (_driverListDto != null && _driverListDto.DriverDtos != null)
        {
            _lastAddedDrivers = _driverListDto.DriverDtos.OrderByDescending(d => d.CreatedAt).Take(5).ToList();
        }
        else
        {
            _lastAddedDrivers = new List<DriverDto>();
        }

    }

    private void GetLastAddedVehicles()
    {
        if (_vehicleListDto != null && _vehicleListDto.VehicleDtos != null)
        {
            _lastAddedVehicles = _vehicleListDto.VehicleDtos.OrderByDescending(d => d.CreatedAt).Take(5).ToList();
        }
        else
        {
            _lastAddedVehicles = new List<VehicleDto>();
        }

    }

    private void GetLastAddedFuelCards()
    {
        if (_fuelCardListDto != null && _fuelCardListDto.FuelCardDtos != null)
        {
            _lastAddedFuelCards = _fuelCardListDto.FuelCardDtos.OrderByDescending(d => d.CreatedAt).Take(5).ToList();
        }
        else
        {
            _lastAddedFuelCards = new List<FuelCardDto>();
        }

    }

    private void InitializeCharts()
    {
        // For Drivers
        int driversAssignedToVehicles = _driverVehicleListDto.DriverVehicleDtos.Select(dv => dv.DriverId).Distinct().Count();
        int driversNotAssignedToVehicles = _driverListDto.TotalItems - driversAssignedToVehicles;
        int activeDrivers = _driverListDto.DriverDtos.Where(d => d.Status == Status.Active).Count();
        int inactiveDrivers = _driverListDto.DriverDtos.Where(d => d.Status == Status.Deactive).Count();

        _driversChartConfig = GetChartConfig("Bestuurder", new int[] { driversNotAssignedToVehicles, driversAssignedToVehicles, activeDrivers, inactiveDrivers }, new string[] { "#08354a", "#2397d4", "#67a9a9", "#f4a261" }, 1);

        // For Vehicles
        int vehiclesWithDrivers = _driverVehicleListDto.DriverVehicleDtos.Select(dv => dv.VehicleId).Distinct().Count();
        int vehiclesWithoutDrivers = _vehicleListDto.TotalItems - vehiclesWithDrivers;
        int activeVehicles = _vehicleListDto.VehicleDtos.Where(v => v.Status == Status.Active).Count();
        int inactiveVehicles = _vehicleListDto.VehicleDtos.Where(v => v.Status == Status.Deactive).Count();

        _vehiclesChartConfig = GetChartConfig("Voertuig", new int[] { vehiclesWithoutDrivers, vehiclesWithDrivers, activeVehicles, inactiveVehicles }, new string[] { "#08354a", "#2397d4", "#67a9a9", "#f4a261" }, 2);

        // For Fuel Cards
        int fuelCardsWithDrivers = _fuelCardDriverListDto.FuelCardDriverDtos.Select(fd => fd.FuelCardId).Distinct().Count();
        int fuelCardsWithoutDrivers = _fuelCardListDto.TotalItems - fuelCardsWithDrivers;
        int activeFuelCards = _fuelCardListDto.FuelCardDtos.Where(fd => fd.Status == Status.Active).Count();
        int inactiveFuelCards = _fuelCardListDto.FuelCardDtos.Where(fd => fd.Status == Status.Deactive).Count();

        _fuelCardsChartConfig = GetChartConfig("Tankkaarten", new int[] { fuelCardsWithoutDrivers, fuelCardsWithDrivers, activeFuelCards, inactiveFuelCards }, new string[] { "#08354a", "#2397d4", "#67a9a9", "#f4a261" }, 3);
    }



    private PieConfig GetChartConfig(string label, int[] data, string[] backgroundColors, int chart)
    {
        var config = new PieConfig(true)
        {


            Options = new PieOptions
            {
                Responsive = true,
                Title = new OptionsTitle
                {
                    Display = true,
                    Text = label + " Verdeling"
                },

            }
        };

        if (chart == 1)
        {
            config.Data.Labels.Clear();
            foreach (var status in new[] { "Beschikbare Bestuurders", "Bestuurders gekoppeld aan Voertuig", "Actieve Bestuurders", "Inactieve Bestuurders" })
            {
                config.Data.Labels.Add(status);
            }
        }

        if (chart == 2)
        {
            config.Data.Labels.Clear();
            foreach (var status in new[] { "Beschikbare Voertuigen", "Voertuigen gekoppeld aan Bestuurder", "Actieve Voertuigen", "Inactieve Voertuigen" })
            {
                config.Data.Labels.Add(status);
            }
        }

        if (chart == 3)
        {
            config.Data.Labels.Clear();
            foreach (var status in new[] { "Beschikbare Tankkaarten", "Tankkaarten gekoppeld aan Bestuurder", "Actieve Tankkaarten", "Inactieve Tankkaarten" })
            {
                config.Data.Labels.Add(status);
            }
        }


        var dataset = new PieDataset<int>(data)
        {
            BackgroundColor = backgroundColors,

        };

        config.Data.Datasets.Add(dataset);

        return config;
    }
}

