@page "/fuelcards"

@using AllPhi.HoGent.Blazor.Services
@using AllPhi.HoGent.Blazor.Dto
@using AllPhi.HoGent.Blazor.Components

@inject IFuelCardServices _fuelCardService
@inject IDriverServices _driverService
@inject IVehicleServices _vehicleService
@inject IFuelCardDriverServices _fuelCardDriverService
@inject IDriverVehicleServices _driverVehicleService

<PageTitle>FuelCards</PageTitle>


@if (_isLoading)
{
    <LoadingSpinner IsLoading="@_isLoading" />
}

@code {
    private bool _isLoading = true;

    private DriverListDto? _driverListDto;
    private FuelCardListDto? _fuelCardListDto;

    private int _pageNumber = 1;
    private int _pageSize = 5;
    private int _totalPages;
    private bool _isSortAscending = false;
    private string _currentSortColumn = "date";

    private bool _addNewFuelCard = false;
    private bool _selectedFuelCard = false;
    private bool _fuelCardUpdated = false;
    private bool _fuelCardDeleted = false;

    private bool _showSendConfirmation = false;
    private bool _fuelCardAdded = false;
    private bool _error = false;

    private FuelCardDto _selectedFuelCardDto = new();
    private List<DriverDto> _checkedDriver = new();
    private List<FuelCardDriverDto> _fuelCardDriverDtos = new();



    protected override async Task OnInitializedAsync()
    {
        await LoadFuelCardListDto();
        _driverListDto = await _driverService.GetAllDriversAsync();
        _isLoading = false;
    }

    private async Task LoadFuelCardListDto()
    {
        _fuelCardListDto = await _fuelCardService.GetAllFuelCardsAsync(_currentSortColumn, _isSortAscending, _pageNumber, _pageSize);
        _totalPages = (int)Math.Ceiling((double)_fuelCardListDto.TotalItems / _pageSize);
    }

    private void AddNewFuelCard()
    {
        SetBoolDefault();

        _selectedFuelCard = false;
        _addNewFuelCard = true;
    }

    private void SetBoolDefault()
    {
        _showSendConfirmation = false;
        _fuelCardAdded = false;
        _error = false;
    }


    private async Task SelectFuelCard(FuelCardDto selectedCard)
    {
        _selectedFuelCardDto = selectedCard;
        _fuelCardDriverDtos = (await _fuelCardDriverService.GetFuelCardWithConnectedDriversByFuelCardId(_selectedFuelCardDto.Id)).Item1;
        var v = _fuelCardDriverDtos.Select(x => _driverListDto.DriverDtos.Where(r => x.DriverId == r.Id).ToList()).ToList();
        _checkedDriver = v.SelectMany(x => x.Select(x => x).ToList()).ToList();
        _showSendConfirmation = false;
        _selectedFuelCard = true;
        _addNewFuelCard = false;
        _fuelCardAdded = false;
        _fuelCardUpdated = false;
        _fuelCardDeleted = false;
        _error = false;
    }
}

